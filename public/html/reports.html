<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Student & Faculty Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 z-50 w-64 bg-white dark:bg-gray-800 shadow-lg">
        <div class="flex items-center justify-between h-16 px-6 bg-blue-600">
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="white" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"></path><path d="M6 12v5c3 3 9 3 12 0v-5"></path></svg>
                <span class="text-white font-bold text-lg">SFMS</span>
            </div>
        </div>
        <nav class="mt-6 px-4">
            <a href="dashboard.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 mb-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                <span>Dashboard</span>
            </a>
            <a href="students.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 mb-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                <span>Students</span>
            </a>
            <a href="faculty.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 mb-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><polyline points="17 11 19 13 23 9"></polyline></svg>
                <span>Faculty</span>
            </a>
            <a href="reports.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-600 mb-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                <span>Reports</span>
            </a>
            <a href="settings.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 mb-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v6m0 6v6"></path></svg>
                <span>Settings</span>
            </a>
            <a href="profile.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 mb-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                <span>Profile</span>
            </a>
        </nav>
        <div class="absolute bottom-0 w-full p-4">
            <button onclick="logout()" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 w-full">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                <span>Logout</span>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="ml-64 min-h-screen">
        <header class="bg-white dark:bg-gray-800 shadow-sm">
            <div class="px-6 py-4">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Reports</h1>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Generate and export reports</p>
            </div>
        </header>

        <main class="p-6">
            <!-- Tabs -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm mb-6">
                <div class="flex border-b border-gray-200 dark:border-gray-700">
                    <button onclick="switchTab('student')" id="studentTab" class="tab-active px-6 py-4 text-sm font-medium">Student Reports</button>
                    <button onclick="switchTab('faculty')" id="facultyTab" class="px-6 py-4 text-sm font-medium text-gray-600 dark:text-gray-400">Faculty Reports</button>
                    <button onclick="switchTab('enrollment')" id="enrollmentTab" class="px-6 py-4 text-sm font-medium text-gray-600 dark:text-gray-400">Enrollment Reports</button>
                </div>
            </div>

            <!-- Student Reports -->
            <div id="studentContent" class="space-y-6">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Student Report Filters</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Department</label>
                            <select id="studentDepartment" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg dark:bg-gray-700 dark:text-white">
                                <option value="">All Departments</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Course</label>
                            <select id="studentCourse" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg dark:bg-gray-700 dark:text-white">
                                <option value="">All Courses</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Academic Year</label>
                            <select id="studentAcademicYear" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg dark:bg-gray-700 dark:text-white">
                                <option value="">All Years</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Category</label>
                            <select id="studentCategory" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg dark:bg-gray-700 dark:text-white">
                                <option value="">All Categories</option>
                                <option value="freshman">Freshman</option>
                                <option value="transferee">Transferee</option>
                                <option value="returnee">Returnee</option>
                                <option value="regular">Regular</option>
                                <option value="irregular">Irregular</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex space-x-3">
                        <button onclick="generateStudentReport('excel')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                            <span>Export to Excel</span>
                        </button>
                        <button onclick="generateStudentReport('pdf')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                            <span>Export to PDF</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Faculty Reports -->
            <div id="facultyContent" class="hidden space-y-6">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Faculty Report Filters</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Department</label>
                            <select id="facultyDepartment" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg dark:bg-gray-700 dark:text-white">
                                <option value="">All Departments</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Employment Type</label>
                            <select id="facultyEmploymentType" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg dark:bg-gray-700 dark:text-white">
                                <option value="">All Types</option>
                                <option value="full_time">Full Time</option>
                                <option value="part_time">Part Time</option>
                                <option value="contract">Contract</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex space-x-3">
                        <button onclick="generateFacultyReport('excel')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                            <span>Export to Excel</span>
                        </button>
                        <button onclick="generateFacultyReport('pdf')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                            <span>Export to PDF</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Enrollment Reports -->
            <div id="enrollmentContent" class="hidden space-y-6">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Enrollment Report Filters</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Academic Year</label>
                            <select id="enrollmentAcademicYear" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg dark:bg-gray-700 dark:text-white">
                                <option value="">All Years</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Department</label>
                            <select id="enrollmentDepartment" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg dark:bg-gray-700 dark:text-white">
                                <option value="">All Departments</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Course</label>
                            <select id="enrollmentCourse" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg dark:bg-gray-700 dark:text-white">
                                <option value="">All Courses</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex space-x-3">
                        <button onclick="generateEnrollmentReport('excel')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                            <span>Export to Excel</span>
                        </button>
                        <button onclick="generateEnrollmentReport('pdf')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                            <span>Export to PDF</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let departments = [];
        let courses = [];
        let academicYears = [];

        async function loadData() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const [deptResp, courseResp, yearResp] = await Promise.all([
                    fetch('/api/departments', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/courses', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/academic-years', { headers: { 'Authorization': `Bearer ${token}` } })
                ]);

                departments = (await deptResp.json()).data || [];
                courses = (await courseResp.json()).data || [];
                academicYears = (await yearResp.json()).data || [];

                populateDropdowns();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function populateDropdowns() {
            const deptSelects = ['studentDepartment', 'facultyDepartment', 'enrollmentDepartment'];
            deptSelects.forEach(id => {
                const select = document.getElementById(id);
                departments.forEach(dept => {
                    select.innerHTML += `<option value="${dept.id}">${dept.name}</option>`;
                });
            });

            const courseSelects = ['studentCourse', 'enrollmentCourse'];
            courseSelects.forEach(id => {
                const select = document.getElementById(id);
                courses.forEach(course => {
                    select.innerHTML += `<option value="${course.id}">${course.name}</option>`;
                });
            });

            const yearSelects = ['studentAcademicYear', 'enrollmentAcademicYear'];
            yearSelects.forEach(id => {
                const select = document.getElementById(id);
                academicYears.forEach(year => {
                    select.innerHTML += `<option value="${year.id}">${year.year || year.name}</option>`;
                });
            });
        }

        function switchTab(tab) {
            ['studentTab', 'facultyTab', 'enrollmentTab'].forEach(t => {
                document.getElementById(t).classList.remove('tab-active', 'text-blue-600');
                document.getElementById(t).classList.add('text-gray-600', 'dark:text-gray-400');
            });
            ['studentContent', 'facultyContent', 'enrollmentContent'].forEach(c => {
                document.getElementById(c).classList.add('hidden');
            });

            document.getElementById(tab + 'Tab').classList.add('tab-active', 'text-blue-600');
            document.getElementById(tab + 'Tab').classList.remove('text-gray-600', 'dark:text-gray-400');
            document.getElementById(tab + 'Content').classList.remove('hidden');
        }

        async function generateStudentReport(format) {
            const token = localStorage.getItem('token');
            const params = new URLSearchParams({
                department_id: document.getElementById('studentDepartment').value,
                course_id: document.getElementById('studentCourse').value,
                academic_year: document.getElementById('studentAcademicYear').value,
                category: document.getElementById('studentCategory').value
            });

            try {
                const response = await fetch(`/api/reports/students/${format}?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `students_report.${format === 'excel' ? 'xlsx' : 'pdf'}`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Failed to generate report');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to generate report');
            }
        }

        async function generateFacultyReport(format) {
            const token = localStorage.getItem('token');
            const params = new URLSearchParams({
                department_id: document.getElementById('facultyDepartment').value,
                employment_type: document.getElementById('facultyEmploymentType').value
            });

            try {
                const response = await fetch(`/api/reports/faculty/${format}?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `faculty_report.${format === 'excel' ? 'xlsx' : 'pdf'}`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Failed to generate report');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to generate report');
            }
        }

        async function generateEnrollmentReport(format) {
            const token = localStorage.getItem('token');
            const params = new URLSearchParams({
                academic_year: document.getElementById('enrollmentAcademicYear').value,
                department_id: document.getElementById('enrollmentDepartment').value,
                course_id: document.getElementById('enrollmentCourse').value
            });

            try {
                const response = await fetch(`/api/reports/enrollment/${format}?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `enrollment_report.${format === 'excel' ? 'xlsx' : 'pdf'}`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Failed to generate report');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to generate report');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
